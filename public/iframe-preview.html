<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Preview Sandbox</title>
    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background-color: white;
      }
      .element-selected {
        outline: 2px dashed #f43f5e !important;
        outline-offset: 2px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      let currentSelection = null;
      let reactRoot = null; // Store the root instance globally

      // Initialize the root only once
      const initializeRoot = () => {
        if (!reactRoot) {
          const container = document.getElementById("root");
          reactRoot = ReactDOM.createRoot(container);
        }
      };

      const injectInspector = () => {
        let idCounter = 0;
        document.querySelectorAll("#root *").forEach((el) => {
          if (el.dataset.editorId) return;
          const elementId = `el-${idCounter++}`;
          el.dataset.editorId = elementId;
          el.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (currentSelection) {
              currentSelection.classList.remove("element-selected");
            }
            el.classList.add("element-selected");
            currentSelection = el;
            window.parent.postMessage(
              {
                type: "ELEMENT_SELECTED",
                data: {
                  id: elementId,
                  tag: el.tagName.toLowerCase(),
                },
              },
              "*"
            );
          });
        });
      };

      const compileAndRender = (jsxCode) => {
        try {
          // Ensure root is initialized
          initializeRoot();

          // Transform JSX to regular JavaScript
          const transformedCode = Babel.transform(jsxCode, {
            presets: ["react"],
            filename: "component.jsx",
          }).code;

          // Create a function that returns the component
          // Remove import statements and export default, replace with direct component
          let cleanCode = transformedCode
            .replace(/import\s+.*?from\s+['"][^'"]*['"];?\s*/g, "") // Remove imports
            .replace(/export\s+default\s+/, "return "); // Replace export default with return

          // Wrap in a function and execute it to get the component
          const componentFunction = new Function("React", `${cleanCode}`);
          const Component = componentFunction(React);

          // Use the existing root to render (don't create a new one!)
          reactRoot.render(React.createElement(Component));

          setTimeout(injectInspector, 100);
        } catch (error) {
          console.error("Render Error:", error);
          initializeRoot();
          reactRoot.render(
            React.createElement(
              "div",
              {
                style: {
                  color: "red",
                  padding: "20px",
                  fontFamily: "monospace",
                },
              },
              [
                React.createElement("h3", { key: "title" }, "Render Error:"),
                React.createElement("pre", { key: "error" }, error.message),
              ]
            )
          );
        }
      };

      window.addEventListener("message", (event) => {
        const { type, payload } = event.data || {};
        if (type === "RENDER_CODE") {
          compileAndRender(payload.code);
        }
        if (type === "UPDATE_STYLE") {
          const { elementId, newStyles } = payload;
          const el = document.querySelector(`[data-editor-id="${elementId}"]`);
          if (el) {
            Object.assign(el.style, newStyles);
          }
        }
      });

      // Default render so iframe shows something on load
      compileAndRender(`
        export default function Demo() {
          return (
            <div className="p-6 text-center text-white bg-blue-600 rounded-xl shadow-lg">
              Hello from Preview ðŸš€
            </div>
          );
        }
      `);
    </script>
  </body>
</html>
